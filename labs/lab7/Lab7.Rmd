---
title: "Week 7: Fitting Logistic Growth Curves to Data"
subtitle: 'EFB 370 - Spring 2023'
author: "Dr. Gurarie"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_float: true
---


```{css, echo = FALSE}
blockquote {
    padding: 10px 20px;
    margin: 0 0 20px;
    font-size: 16px;
    color: darkgreen;
    font-family: "Garamond";
    background: #DFD;
    border-left: 5px solid #262; 
}
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warnings = FALSE, message = FALSE)
```
```{r, echo = FALSE}
require(elieslides)
```


```{r, echo = FALSE, eval = FALSE}
require(gauseR)
data(gause_1934_book_f22)
a <- gause_1934_book_f22
#require(elieslides)
#ggplot(a, aes(Day, Volume_Species1, col = Treatment)) + geom_point()
a <- subset(gause_1934_book_f22, Treatment == "Pa")
b <- a[,c("Species1","Day","Volume_Species2")] %>% 
    plyr::rename(c(Species1 = "Species", Volume_Species2 = "Nt")) %>% 
    mutate(Nt1 = c(NA,Nt[-n]),
           dN = Nt-Nt1,
           r = dN/Nt1)
par(mfrow = c(1,3))
plot(Nt~Day, data = b)
plot(dN~Nt1, data = b)
plot(r~Nt1, data = b)
write.csv(b, file = "paramecium.csv", row.names = FALSE)
```


# Loading and exploring Paramecium data

The [`paramecium.csv`](paramecium.csv) data set contains observations of paramecia  (unicellular ciliates) densities (in unclear units) measured daily in a petri dish with limited resources. 

```{r}
p <- read.csv("paramecium.csv")
```

Look at the columns in this data:

```{r}
head(p)
```

Note the output of the following commands:

```{r, eval = FALSE}
nrow(p)
ncol(p)
dim(p)
names(p)
```

The columns are: `Species`, `Day` of experiment, `Nt` - quantity of paramecium now, `Nt1` - quantity 1 time step ago $\Delta N_{t-1}$, and $r$ - per-capita growth rate, i.e. $\Delta N_t/N_t$.  


# Fit Method I: By Hand

Open the script file [`logisticfitscript.R`](logisticfitscript.R) (you can click on the file name, and either download, or just paste into a NEW script).  It contains just the following code:

```{r}
p <- read.csv("paramecium.csv")

plot(Nt ~ Day, data = p)
N.logistic <- function(x, N0, K, r0) K/(1 + ((K - N0)/N0)*exp(-r0*x))

# try different values!
N0 <- 10
K <- 150
r0 <- 1.5
curve(N.logistic(x, N0, K, r0), add = TRUE, col = 2, lwd = 2)
```

The initial values guessed for `N0`, `K`, and `r0` are not very good.  

> # Lab Exercise 1
> 
> Experiment with those numbers and see how close you can come (visually) to fitting the curve.  Report your estimates for $N_0$, $K$, and $r_0$ and include a plot of the fit. 



# Fit method II: Using $r(N)$

## Ploting N, dN and r

Lets plot the three figures we talked about in class:  $N$ as a function of time, $\Delta N$ as a function of $N$, and $r$ as a function of $N$

```{r, echo = FALSE, par = -1, fig.height = 3, fig.width = 9}
pars(); par(mfrow = c(1,3))
plot(Nt~Day, data = p)
plot(dN~Nt1, data = p)
plot(r~Nt1, data = p)
```

These roughly show the patterns we expect of logistic regression.  

## Linear model of R

One form of the logistic growth model simply says that: 

$$ r(N) = r_0 - {r_0 \over K} N$$

So if we do a straightforward linear regression, we can estimate both $r$ and $K$:

```{r}
lm(r ~ Nt1, data = p)
```

This suggests that r0 is roughly 1.09.  We write:  $$\widehat{r_0} = 1.09$$ 

What does the slope tell us?  Well - we can convert that to a carrying capacity, since:  $$\beta = -r_0/K.$$

Solving for $\widehat{K}$ we get: $$\widehat{K} = 1.088 / 0.0052 = 209.1$$

## Check the fit

Is this estimate any good? Try putting these numbers into the fitting code:

```{r, eval = FALSE}
N0 <- 10
K <- 209
r0 <- 1.088
plot(Nt~Day, data = p)
curve(N.logistic(x, N0, K, r0), add = TRUE, col = 2, lwd = 2)
```

We need to adjust $N_0$ - but otherwise not too bad. 

## Standard errors

Note - we can - again - get standard errors around these coefficients: 

```{r}
r.lm <- lm(r ~ Day, data = p)
summary(r.lm)
```

This is pretty good!  Especially for the $r_0$ variable - basically $\widehat{r} 1.2 \pm 0.42$. But, two (small) problems: 

- hard to convert these to a standard error around $K$
- no way to obatin an estimate for $N_0$ from this model 


# Fit Method III:  Non-linear least squares

One method of fitting a curve is to use the "least squares" method, i.e. find the parameters for which the squared devation of the data from the curve is minimized.  This is an *optimization* problem that the computer solves numerically. 

The function that does this in R is called `nls()`.  It is "non-linear", unlike the regression model above.  To do this, we have to use our function for the solution of the logistic curve and provide initial values.  But the basic syntax is similar in that the response is `Nt` and the predictor is the logistic function of time (`Day`),  with the parameters to be estimated following that `Day`.  And the formula symbol is always `~`. 

```{r}
p <- read.csv("paramecium.csv")
N.logistic <- function(x, N0, K, r0) K/(1 + ((K - N0)/N0)*exp(-r0*x))

nls(Nt ~ N.logistic(Day, N0, K, r0), data = p, 
    start = list(N0 = 1, K = 200, r0 = 0.75))
```

As usual, we can save the results to an object and get a summary table with the fits:

```{r}
summary(nls(Nt ~ N.logistic(Day, N0, K, r0), data = p, 
    start = list(N0 = 1, K = 200, r0 = 0.75)))
```


<font color = "red">

# Additional homework problem 4

> Report the estimates of a fitted logistic curve to the Paramecium data, with confidence intervals and produce a plot of the fitted curve to the data.  

</font>



> # Lab Exercise 1
> 
> Load the population data from England and Wales - at this file: `england_population.csv`
> 
> Use these subsetted data and:
> 
> 1. Plot the relationship between Weight and Length for each of males and females
> 2. Fit a model and add the regression line to the plot. 
> 3. Report the estimate at 95% C.I. of the slope coefficient for males and females.  Based on these results, do they have different growth curves? 

```{r, echo = FALSE}
england <- read.csv("england_population.csv")

```
